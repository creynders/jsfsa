/*! jsfsa - v0.2.3 - 2012-04-14
* /
* Copyright (c) 2012 Camille Reynders (http://www.creynders.be/); Licensed MIT */
(function(a){"use strict";if(a.hasOwnProperty("jsfsa"))return;var b={VERSION:"0.2.3"},c=function(){this._listeners={}};c.prototype.addListener=function(a,b){return this._listeners.hasOwnProperty(a)||(this._listeners[a]=[]),this._listeners[a].push(b),this},c.prototype.addListeners=function(a,b){if(typeof b=="function")return this.addListener(a,b);var c;return this._listeners.hasOwnProperty(a)?c=this._listeners[a]:c=[],this._listeners[a]=c.concat(b),this},c.prototype.hasListener=function(a,b){if(this._listeners.hasOwnProperty(a)){var c=this._listeners[a].indexOf(b);return c>=0}return!1},c.prototype.removeListener=function(a,b){if(this._listeners.hasOwnProperty(a)){var c=this._listeners[a].indexOf(b);c>=0&&this._listeners[a].splice(c,1)}return this},c.prototype.dispatch=function(a){var b=a.type,c=!0;if(this._listeners.hasOwnProperty(b)){var d=Array.prototype.slice.call(arguments);for(var e=0,f=this._listeners[b].length;e<f;e++){var g=this._listeners[b][e];c=g.apply(this,d)&&c}}return c};var d=function(){};d.prototype=c.prototype,b.StateEvent=function(a,b,c,d){this.fqn="jsfsa.StateEvent",this.type=a,this.from=b,this.to=c,this.transition=d},b.StateEvent.ENTERED="entered",b.StateEvent.EXITED="exited",b.StateEvent.ENTRY_DENIED="entryDenied",b.StateEvent.EXIT_DENIED="exitDenied",b.StateEvent.TRANSITION_DENIED="transitionDenied",b.StateEvent.CHANGED="changed",b.StateEvent.prototype={clone:function(){var a=new b.StateEvent(this.type,this.from,this.to,this.transition);return a},_setType:function(a){return this.type=a,this}},b.Action=function(){},b.Action.ENTRY="entry",b.Action.EXIT="exit",b.State=function(a,b){c.call(this),this.fqn="jsfsa.State",this.name="",this.parent=undefined,this.isInitial=!1,this._guardian=undefined,this._transitions={},this._parseName(a),this.parseData(b)},b.State.prototype=new d,b.State.prototype.constructor=b.State,b.State._configMembers=["isInitial","guards","listeners","parent","transitions"],b.State.prototype.addTransition=function(a,b){return this._transitions[a]=b,this},b.State.prototype.removeTransition=function(a){return delete this._transitions[a],this},b.State.prototype.getTransition=function(a){return this._transitions[a]},b.State.prototype.hasTransition=function(a){return this._transitions.hasOwnProperty(a)},b.State.prototype.addGuard=function(a,b){return this._getGuardian().addListener(a,b),this},b.State.prototype.addGuards=function(a,b){return this._getGuardian().addListeners(a,b),this},b.State.prototype.hasGuard=function(a,b){return this._guardian&&this._guardian.hasListener(a,b)},b.State.prototype.removeGuard=function(a,b){return this._guardian&&this._guardian.removeListener(a,b),this},b.State.prototype.parseData=function(a){if(a){a.isInitial&&(this.isInitial=!0),a.guards&&(a.guards[b.Action.ENTRY]&&this.addGuards(b.Action.ENTRY,a.guards[b.Action.ENTRY]),a.guards[b.Action.EXIT]&&this.addGuards(b.Action.EXIT,a.guards[b.Action.EXIT]));for(var c in a.listeners)a.listeners.hasOwnProperty(c)&&this.addListeners(c,a.listeners[c]);a.parent&&(this.parent=a.parent),a.transitions&&this._addTransitions(a.transitions),this._addTransitions(a,b.State._configMembers)}},b.State.prototype.destroy=function(){this._guardian=undefined,this._transitions=undefined,this._listeners=undefined,this.name=undefined},b.State.prototype._getGuardian=function(){return this._guardian===undefined&&(this._guardian=new c),this._guardian},b.State.prototype._parseName=function(a){var b=a.lastIndexOf("/");b>=0&&(this.parent=a.substring(0,b)),this.name=a},b.State.prototype._executeGuards=function(a){var b=!0;if(this._guardian){b=this._guardian.dispatch.apply(this._guardian,a);if(!b){a=a.slice(0);var c=a[0].clone();c.type+="Denied",a[0]=c,this.dispatch.apply(this,a)}}return b},b.State.prototype._addTransitions=function(a,b){for(var c in a)if(a.hasOwnProperty(c)){if(b&&b.indexOf(c)>=0)continue;this.addTransition(c,a[c])}},b.State.prototype._dispatchArgs=function(a){this.dispatch.apply(this,a)};var e=function(a){this.state=a,this.parent=undefined,this.children=undefined,this.initialChild=undefined};e.prototype={addChild:function(a){this.children||(this.children={}),a.parent=this,a.state.isInitial&&(this.initialChild=a),this.children[a.state.name]=a},removeChild:function(a){this.initialChild===a&&(this.initialChild=undefined),delete this.children[a.state.name]},destroy:function(){for(var a in this.children)this.children.hasOwnProperty(a)&&this.children[a].destroy();this.state=undefined,this.parent=undefined,this.children=undefined},getInitialBranch:function(){var a=[],b=this.initialChild;while(b)a.push(b),b=b.initialChild;return a}};var f=function(a,b,c,d){this.payload=a,this.from=c,this.to=d,this.transition=b};f.prototype={createEvent:function(a){return new b.StateEvent(a,this.from,this.to,this.transition)},createArgsArray:function(a){var b=this.payload.slice(0);return b.unshift(this.createEvent(a)),b}},b.Automaton=function(a){c.call(this),this.fqn="jsfsa.Automaton",this._nodes={},this._rootNode=new e(new b.State("root")),this._currentBranch=[this._rootNode],this._internalState="ready",this._queue=[],this._newBranch=undefined,a&&this.parse(a)},b.Automaton.prototype=new d,b.Automaton.prototype.constructor=b.Automaton,b.Automaton.prototype.isTransitioning=function(){return this._internalState!=="ready"},b.Automaton.prototype.getRootState=function(){return this._rootNode.state},b.Automaton.prototype.getCurrentState=function(){return this._currentBranch[this._currentBranch.length-1].state},b.Automaton.prototype.createState=function(a,c){var d=new b.State(a,c);return this.addState(d),this},b.Automaton.prototype.addState=function(a){if(!this.hasState(a.name)){var b=new e(a),c=a.parent?this._nodes[a.parent]:this._rootNode;c.addChild(b),a.isInitial&&c.state===this.getCurrentState()&&this._currentBranch.push(b),this._nodes[a.name]=b}return this},b.Automaton.prototype.hasState=function(a){return this._nodes.hasOwnProperty(a)},b.Automaton.prototype.getState=function(a){return this.hasState(a)?this._nodes[a].state:undefined},b.Automaton.prototype.removeState=function(a){if(this.hasState(a)){var b=this._nodes[a],c=b.parent;c.removeChild(b);var d=this._currentBranch.indexOf(b);d>=0&&this._currentBranch.splice(d,this._currentBranch.length-d),b.destroy(),delete this._nodes[a]}return this},b.Automaton.prototype.doTransition=function(a){if(this._internalState==="ready"){var c;arguments.length>1?(c=Array.prototype.slice.call(arguments),c.shift()):c=[],this._newBranch=this._currentBranch;var d=new f(c,a,this.getCurrentState().name),e=this._hasTransitionInCurrentBranch(a);e===undefined?this._finishTransition(d.createArgsArray(b.StateEvent.TRANSITION_DENIED)):this._attemptTransition(e,d)}return this},b.Automaton.prototype.parse=function(a){for(var b in a)a.hasOwnProperty(b)&&this.createState(b,a[b]);return this},b.Automaton.prototype.proceed=function(){if(this._internalState==="transitioning"||this._internalState==="paused")if(this._queue.length>0){this._internalState="transitioning";var a=this._queue.shift(),b=a.obj.state;b[a.method].call(b,a.args),this._internalState!=="paused"&&this.proceed()}return this},b.Automaton.prototype.pause=function(){return this._internalState==="transitioning"&&(this._internalState="paused"),this},b.Automaton.prototype.destroy=function(){this._rootNode.destroy(),this._rootNode=undefined,this._nodes=undefined,this._currentBranch=undefined},b.Automaton.prototype._hasTransitionInCurrentBranch=function(a){var b,c=!1;for(var d=this._currentBranch.length-1,e=0;d>=e;d--){b=this._currentBranch[d].state;if(b.hasTransition(a)){c=!0;break}}return c?b:undefined},b.Automaton.prototype._attemptTransition=function(a,c){var d=this._nodes[a.getTransition(c.transition)];if(!d)this._finishTransition(c.createArgsArray(b.StateEvent.TRANSITION_DENIED));else{c.to=d.state.name;var e=d.getInitialBranch();this._newBranch=this._getBranchFromRoot(d).concat(e);var f=this._getShortestRoute(this._currentBranch,this._newBranch);this._doExitGuardPhase(f,c)}},b.Automaton.prototype._getBranchFromRoot=function(a){var b=[];while(a)b.unshift(a),a=a.parent;return b},b.Automaton.prototype._getShortestRoute=function(a,b){var c,d=Math.min(a.length,b.length);for(c=0;c<d;c++)if(a[c]!==b[c])break;var e=a.slice(c).reverse(),f=b.slice(c);return{up:e,down:f}},b.Automaton.prototype._doExitGuardPhase=function(a,c){this._internalState="guarding";var d=this._executeGuards(a.up,c.createArgsArray(b.Action.EXIT));return d?d=this._doEntryGuardPhase(a,c):(this._newBranch=undefined,this._finishTransition(c.createArgsArray(b.StateEvent.EXIT_DENIED))),d},b.Automaton.prototype._doEntryGuardPhase=function(a,c){var d=this._executeGuards(a.down,c.createArgsArray(b.Action.ENTRY));return d?this._startTransition(a,c):(this._newBranch=undefined,this._finishTransition(c.createArgsArray(b.StateEvent.ENTRY_DENIED))),d},b.Automaton.prototype._executeGuards=function(a,b){var c=!0;for(var d=0,e=a.length;d<e;d++){var f=a[d].state;c=f._executeGuards(b)&&c}return c},b.Automaton.prototype._startTransition=function(a,c){this._internalState="transitioning",this._currentBranch=undefined;var d=[{state:this}],e=c.createArgsArray(b.StateEvent.EXITED);this._queue=[],this._addToQueue(a.up,"_dispatchArgs",e),this._addToQueue(d,"_dispatchArgs",e),e=c.createArgsArray(b.StateEvent.ENTERED),this._addToQueue(a.down,"_dispatchArgs",e),this._addToQueue(d,"_dispatchArgs",e),this._addToQueue(d,"_finishTransition",c.createArgsArray(b.StateEvent.CHANGED)),this.proceed()},b.Automaton.prototype._addToQueue=function(a,b,c){for(var d=0,e=a.length;d<e;d++)this._queue.push({obj:a[d],args:c,method:b})},b.Automaton.prototype._finishTransition=function(a){this._newBranch?this._currentBranch=this._newBranch:this._newBranch=undefined,this._internalState="ready",this._dispatchArgs(a)},b.Automaton.prototype._dispatchArgs=b.State.prototype._dispatchArgs,a.jsfsa=b})(this)