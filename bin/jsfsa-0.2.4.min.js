/*! jsfsa - v0.2.4 - 2013-04-10 Copyright (c) 2013 Camille Reynders (http://www.creynders.be/); Licensed MIT */(function(t){"use strict";if(!t.hasOwnProperty("jsfsa")){var n={VERSION:"0.2.4"},e=function(){this._listeners={}};e.prototype.addListener=function(t,n){return this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]),this._listeners[t].push(n),this},e.prototype.addListeners=function(t,n){if("function"==typeof n)return this.addListener(t,n);var e;return e=this._listeners.hasOwnProperty(t)?this._listeners[t]:[],this._listeners[t]=e.concat(n),this},e.prototype.hasListener=function(t,n){if(this._listeners.hasOwnProperty(t)){var e=this._listeners[t].indexOf(n);return e>=0}return!1},e.prototype.removeListener=function(t,n){if(this._listeners.hasOwnProperty(t)){var e=this._listeners[t].indexOf(n);e>=0&&this._listeners[t].splice(e,1)}return this},e.prototype.dispatch=function(t){var n=t.type,e=!0;if(this._listeners.hasOwnProperty(n))for(var i=Array.prototype.slice.call(arguments),r=0,s=this._listeners[n].length;s>r;r++){var a=this._listeners[n][r];e=a.apply(this,i)&&e}return e};var i=function(){};i.prototype=e.prototype,n.StateEvent=function(t,n,e,i){this.fqn="jsfsa.StateEvent",this.type=t,this.from=n,this.to=e,this.transition=i},n.StateEvent.ENTERED="entered",n.StateEvent.EXITED="exited",n.StateEvent.ENTRY_DENIED="entryDenied",n.StateEvent.EXIT_DENIED="exitDenied",n.StateEvent.TRANSITION_DENIED="transitionDenied",n.StateEvent.CHANGED="changed",n.StateEvent.prototype={clone:function(){var t=new n.StateEvent(this.type,this.from,this.to,this.transition);return t},_setType:function(t){return this.type=t,this}},n.Action=function(){},n.Action.ENTRY="entry",n.Action.EXIT="exit",n.State=function(t,n){e.call(this),this.fqn="jsfsa.State",this.name="",this.parent=void 0,this.isInitial=!1,this._guardian=void 0,this._transitions={},this._parseName(t),this.parseData(n)},n.State.prototype=new i,n.State.prototype.constructor=n.State,n.State._configMembers=["isInitial","guards","listeners","parent","transitions"],n.State.prototype.addTransition=function(t,n){return this._transitions[t]=n,this},n.State.prototype.removeTransition=function(t){return delete this._transitions[t],this},n.State.prototype.getTransition=function(t){return this._transitions[t]},n.State.prototype.hasTransition=function(t){return this._transitions.hasOwnProperty(t)},n.State.prototype.addGuard=function(t,n){return this._getGuardian().addListener(t,n),this},n.State.prototype.addGuards=function(t,n){return this._getGuardian().addListeners(t,n),this},n.State.prototype.hasGuard=function(t,n){return this._guardian&&this._guardian.hasListener(t,n)},n.State.prototype.removeGuard=function(t,n){return this._guardian&&this._guardian.removeListener(t,n),this},n.State.prototype.parseData=function(t){if(t){t.isInitial&&(this.isInitial=!0),t.guards&&(t.guards[n.Action.ENTRY]&&this.addGuards(n.Action.ENTRY,t.guards[n.Action.ENTRY]),t.guards[n.Action.EXIT]&&this.addGuards(n.Action.EXIT,t.guards[n.Action.EXIT]));for(var e in t.listeners)t.listeners.hasOwnProperty(e)&&this.addListeners(e,t.listeners[e]);t.parent&&(this.parent=t.parent),t.transitions&&this._addTransitions(t.transitions),this._addTransitions(t,n.State._configMembers)}},n.State.prototype.destroy=function(){this._guardian=void 0,this._transitions=void 0,this._listeners=void 0,this.name=void 0},n.State.prototype._getGuardian=function(){return void 0===this._guardian&&(this._guardian=new e),this._guardian},n.State.prototype._parseName=function(t){var n=t.lastIndexOf("/");n>=0&&(this.parent=t.substring(0,n)),this.name=t},n.State.prototype._executeGuards=function(t){var n=!0;if(this._guardian&&(n=this._guardian.dispatch.apply(this._guardian,t),!n)){t=t.slice(0);var e=t[0].clone();e.type+="Denied",t[0]=e,this.dispatch.apply(this,t)}return n},n.State.prototype._addTransitions=function(t,n){for(var e in t)if(t.hasOwnProperty(e)){if(n&&n.indexOf(e)>=0)continue;this.addTransition(e,t[e])}},n.State.prototype._dispatchArgs=function(t){this.dispatch.apply(this,t)};var r=function(t){this.state=t,this.parent=void 0,this.children=void 0,this.initialChild=void 0};r.prototype={addChild:function(t){this.children||(this.children={}),t.parent=this,t.state.isInitial&&(this.initialChild=t),this.children[t.state.name]=t},removeChild:function(t){this.initialChild===t&&(this.initialChild=void 0),delete this.children[t.state.name]},destroy:function(){for(var t in this.children)this.children.hasOwnProperty(t)&&this.children[t].destroy();this.state=void 0,this.parent=void 0,this.children=void 0},getInitialBranch:function(){for(var t=[],n=this.initialChild;n;)t.push(n),n=n.initialChild;return t}};var s=function(t,n,e,i){this.payload=t,this.from=e,this.to=i,this.transition=n};s.prototype={createEvent:function(t){return new n.StateEvent(t,this.from,this.to,this.transition)},createArgsArray:function(t){var n=this.payload.slice(0);return n.unshift(this.createEvent(t)),n}},n.Automaton=function(t,i){e.call(this),this.fqn="jsfsa.Automaton",this.name=i||"",this._nodes={},this._rootNode=new r(new n.State("root")),this._currentBranch=[this._rootNode],this._internalState="ready",this._queue=[],this._newBranch=void 0,t&&this.parse(t)},n.Automaton.prototype=new i,n.Automaton.prototype.constructor=n.Automaton,n.Automaton.prototype.isTransitioning=function(){return"ready"!==this._internalState},n.Automaton.prototype.getRootState=function(){return this._rootNode.state},n.Automaton.prototype.getCurrentState=function(){return this._currentBranch[this._currentBranch.length-1].state},n.Automaton.prototype.getCurrentBranch=function(){for(var t=this._currentBranch,n=[],e=1;t.length>e;e++){var i=t[e];n.push(i.state)}return n},n.Automaton.prototype.isInCurrentBranch=function(t){var n=this._nodes[t];return n?this._currentBranch.indexOf(n)>-1:!1},n.Automaton.prototype.createState=function(t,e){var i=new n.State(t,e);return this.addState(i),this},n.Automaton.prototype.addState=function(t){if(!this.hasState(t.name)){var n=new r(t),e=t.parent?this._nodes[t.parent]:this._rootNode;e.addChild(n),t.isInitial&&e.state===this.getCurrentState()&&this._currentBranch.push(n),this._nodes[t.name]=n}return this},n.Automaton.prototype.hasState=function(t){return this._nodes.hasOwnProperty(t)},n.Automaton.prototype.getState=function(t){return this.hasState(t)?this._nodes[t].state:void 0},n.Automaton.prototype.removeState=function(t){if(this.hasState(t)){var n=this._nodes[t],e=n.parent;e.removeChild(n);var i=this._currentBranch.indexOf(n);i>=0&&this._currentBranch.splice(i,this._currentBranch.length-i),n.destroy(),delete this._nodes[t]}return this},n.Automaton.prototype.doTransition=function(t){if("ready"===this._internalState){var e;arguments.length>1?(e=Array.prototype.slice.call(arguments),e.shift()):e=[],this._newBranch=this._currentBranch;var i=new s(e,t,this.getCurrentState().name),r=this._hasTransitionInCurrentBranch(t);void 0===r?this._finishTransition(i.createArgsArray(n.StateEvent.TRANSITION_DENIED)):this._attemptTransition(r,i)}return this},n.Automaton.prototype.parse=function(t){for(var n in t)t.hasOwnProperty(n)&&this.createState(n,t[n]);return this},n.Automaton.prototype.proceed=function(){if(("transitioning"===this._internalState||"paused"===this._internalState)&&this._queue.length>0){this._internalState="transitioning";var t=this._queue.shift(),n=t.obj.state;n[t.method].call(n,t.args),"paused"!==this._internalState&&this.proceed()}return this},n.Automaton.prototype.pause=function(){return"transitioning"===this._internalState&&(this._internalState="paused"),this},n.Automaton.prototype.destroy=function(){this._rootNode.destroy(),this._rootNode=void 0,this._nodes=void 0,this._currentBranch=void 0},n.Automaton.prototype._hasTransitionInCurrentBranch=function(t){for(var n,e=!1,i=this._currentBranch.length-1,r=0;i>=r;i--)if(n=this._currentBranch[i].state,n.hasTransition(t)){e=!0;break}return e?n:void 0},n.Automaton.prototype._attemptTransition=function(t,e){var i=this._nodes[t.getTransition(e.transition)];if(i){e.to=i.state.name;var r=i.getInitialBranch();this._newBranch=this._getBranchFromRoot(i).concat(r);var s=this._getShortestRoute(this._currentBranch,this._newBranch);this._doExitGuardPhase(s,e)}else this._finishTransition(e.createArgsArray(n.StateEvent.TRANSITION_DENIED))},n.Automaton.prototype._getBranchFromRoot=function(t){for(var n=[];t;)n.unshift(t),t=t.parent;return n},n.Automaton.prototype._getShortestRoute=function(t,n){var e,i=Math.min(t.length,n.length);for(e=0;i>e&&t[e]===n[e];e++);var r=t.slice(e).reverse(),s=n.slice(e);return{up:r,down:s}},n.Automaton.prototype._doExitGuardPhase=function(t,e){this._internalState="guarding";var i=this._executeGuards(t.up,e.createArgsArray(n.Action.EXIT));return i?i=this._doEntryGuardPhase(t,e):(this._newBranch=void 0,this._finishTransition(e.createArgsArray(n.StateEvent.EXIT_DENIED))),i},n.Automaton.prototype._doEntryGuardPhase=function(t,e){var i=this._executeGuards(t.down,e.createArgsArray(n.Action.ENTRY));return i?this._startTransition(t,e):(this._newBranch=void 0,this._finishTransition(e.createArgsArray(n.StateEvent.ENTRY_DENIED))),i},n.Automaton.prototype._executeGuards=function(t,n){for(var e=!0,i=0,r=t.length;r>i;i++){var s=t[i].state;e=s._executeGuards(n)&&e}return e},n.Automaton.prototype._startTransition=function(t,e){this._internalState="transitioning",this._currentBranch=void 0;var i=[{state:this}],r=e.createArgsArray(n.StateEvent.EXITED);this._queue=[],this._addToQueue(t.up,"_dispatchArgs",r),this._addToQueue(i,"_dispatchArgs",r),r=e.createArgsArray(n.StateEvent.ENTERED),this._addToQueue(t.down,"_dispatchArgs",r),this._addToQueue(i,"_dispatchArgs",r),this._addToQueue(i,"_finishTransition",e.createArgsArray(n.StateEvent.CHANGED)),this.proceed()},n.Automaton.prototype._addToQueue=function(t,n,e){for(var i=0,r=t.length;r>i;i++)this._queue.push({obj:t[i],args:e,method:n})},n.Automaton.prototype._finishTransition=function(t){this._newBranch?this._currentBranch=this._newBranch:this._newBranch=void 0,this._internalState="ready",this._dispatchArgs(t)},n.Automaton.prototype._dispatchArgs=n.State.prototype._dispatchArgs,t.jsfsa=n}})(this);