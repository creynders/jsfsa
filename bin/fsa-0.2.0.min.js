(function(e){if(e.hasOwnProperty("fsa")){return}var c=function(h,i){var g=h.slice(0);g.unshift(i);return g};var f={};f.VERSION="0.2.0";var a=function(){this._listeners={}};a.prototype.addListener=function(g,h){if(!this._listeners.hasOwnProperty(g)){this._listeners[g]=[]}this._listeners[g].push(h);return this};a.prototype.addListeners=function(i,h){if(typeof h==="function"){return this.addListener(i,h)}var g;if(!this._listeners.hasOwnProperty(i)){g=[]}else{g=this._listeners[i]}this._listeners[i]=g.concat(h);return this};a.prototype.hasListener=function(g,i){if(this._listeners.hasOwnProperty(g)){var h=this._listeners[g].indexOf(i);return h>=0}return false};a.prototype.removeListener=function(g,i){if(this._listeners.hasOwnProperty(g)){var h=this._listeners[g].indexOf(i);if(h>=0){this._listeners[g].splice(h,1)}}return this};a.prototype.dispatch=function(m){var h=m.type;var g=true;if(this._listeners.hasOwnProperty(h)){var j=Array.prototype.slice.call(arguments);for(var k=0,o=this._listeners[h].length;k<o;k++){var l=this._listeners[h][k];g=l.apply(this,j)&&g}}return g};var d=function(){};d.prototype=a.prototype;f.StateEvent=function(g,i,h){this.type=g;this.from=i;this.to=h};f.StateEvent.FQN="StateEvent";f.StateEvent.ENTERED="entered";f.StateEvent.EXITED="exited";f.StateEvent.ENTRY_DENIED="entryDenied";f.StateEvent.EXIT_DENIED="exitDenied";f.StateEvent.prototype={clone:function(){return new f.StateEvent(this.type,this.from,this.to)}};f.Action=function(){};f.Action.ENTRY="entry";f.Action.EXIT="exit";f.State=function(g,h){a.call(this);this.name="";this.parent=undefined;this.isInitial=false;this._isTransitioning=false;this._guardian=undefined;this._transitions={};this._parseData(g,h)};f.State.prototype=new d();f.State.prototype.constructor=f.State;f.State.FQN="State";f.State._configMembers=["isInitial","guards","listeners","parent","transitions"];f.State.prototype.addTransition=function(g,h){if(!g||typeof g!=="string"){throw new Error(1040)}if(!h||typeof h!=="string"){throw new Error(1041)}this._transitions[g]=h;return this};f.State.prototype.removeTransition=function(g){delete this._transitions[g];return this};f.State.prototype.getTransition=function(g){return this._transitions[g]};f.State.prototype.hasTransition=function(g){return this._transitions.hasOwnProperty(g)};f.State.prototype.addGuard=function(g,h){this._getGuardian().addListener(g,h);return this};f.State.prototype.addGuards=function(g,h){this._getGuardian().addListeners(g,h);return this};f.State.prototype.hasGuard=function(g,h){return this._guardian&&this._guardian.hasListener(g,h)};f.State.prototype.removeGuard=function(g,h){if(this._guardian){this._guardian.removeListener(g,h)}return this};f.State.prototype.destroy=function(){this._guardian=undefined;this._parent=undefined;this._transitions=undefined;this._listeners=undefined;this.name=undefined;return this};f.State.prototype._getGuardian=function(){if(this._guardian===undefined){this._guardian=new a()}return this._guardian};f.State.prototype._parseName=function(h){var g=h.lastIndexOf("/");if(g>=0){this.parent=h.substring(0,g)}this.name=h};f.State.prototype._executeGuards=function(h){var g=true;if(this._guardian){g=this._guardian.dispatch.apply(this._guardian,h);if(!g){h=h.slice(0);var i=h[0].clone();i.type+="Denied";h[0]=i;this.dispatch.apply(this,h)}}return g};f.State.prototype._addTransitions=function(i,h){for(var g in i){if(i.hasOwnProperty(g)){if(h&&h.indexOf(g)>=0){continue}this.addTransition(g,i[g])}}};f.State.prototype._executeAction=function(g){this.dispatch.apply(this,g)};f.State.prototype._parseData=function(h,i){this._parseName(h);if(i){if(i.isInitial){this.isInitial=true}if(i.guards){if(i.guards[f.Action.ENTRY]){this.addGuards(f.Action.ENTRY,i.guards[f.Action.ENTRY])}if(i.guards[f.Action.EXIT]){this.addGuards(f.Action.EXIT,i.guards[f.Action.EXIT])}}for(var g in i.listeners){if(i.listeners.hasOwnProperty(g)){this.addListeners(g,i.listeners[g])}}if(i.parent){this.parent=i.parent}if(i.transitions){this._addTransitions(i.transitions)}this._addTransitions(i,f.State._configMembers)}};var b=function(g){this.state=g;this.parent=undefined;this.children=undefined;this.initialChild=undefined};b.FQN="Node";b.prototype={addChild:function(g){if(!this.children){this.children={}}g.parent=this;if(g.state.isInitial){this.initialChild=g}this.children[g.state.name]=g},removeChild:function(g){if(this.initialChild===g){this.initialChild=undefined}delete this.children[g.state.name]},destroy:function(){for(var g in this.children){if(this.children.hasOwnProperty(g)){this.children[g].destroy()}}this.state=undefined;this.parent=undefined;this.children=undefined},getInitialBranch:function(){var g=[];var h=this.initialChild;while(h){g.push(h);h=h.initialChild}return g}};f.Automaton=function(g){a.call(this);this._nodes={};this._rootNode=new b(new f.State("root"));this._currentBranch=[this._rootNode];this._internalState="ready";this._queue=[];this._newBranch=undefined;if(g){this.parse(g)}};f.Automaton.prototype=new d();f.Automaton.prototype.constructor=f.Automaton;f.Automaton.FQN="Automaton";f.Automaton.prototype.isTransitioning=function(){return this._internalState==="transitioning"||this._internalState==="paused"};f.Automaton.prototype.getRootState=function(){return this._rootNode.state};f.Automaton.prototype.getCurrentState=function(){return this._currentBranch[this._currentBranch.length-1].state};f.Automaton.prototype.createState=function(i,g){var h=new f.State(i,g);this.addState(h);return this};f.Automaton.prototype.addState=function(i){if(!this.hasState(i.name)){var h=new b(i);var g=(i.parent)?this._nodes[i.parent]:this._rootNode;g.addChild(h);if(i.isInitial&&g.state===this.getCurrentState()){this._currentBranch.push(h)}this._nodes[i.name]=h}return this};f.Automaton.prototype.hasState=function(g){return this._nodes.hasOwnProperty(g)};f.Automaton.prototype.getState=function(g){if(this.hasState(g)){return this._nodes[g].state}return undefined};f.Automaton.prototype.removeState=function(j){if(this.hasState(j)){var i=this._nodes[j];var g=i.parent;g.removeChild(i);var h=this._currentBranch.indexOf(i);if(h>=0){this._currentBranch.splice(h,this._currentBranch.length-h)}i.destroy();delete this._nodes[j]}return this};f.Automaton.prototype.doTransition=function(g){var t;var v=false;for(var m=this._currentBranch.length-1,j=0;m>=j;m--){t=this._currentBranch[m].state;if(t.hasTransition(g)){v=true;break}}if(v){var o=this._nodes[t.getTransition(g)];if(o){var h=o.getInitialBranch();this._newBranch=this._getBranchFromRoot(o).concat(h);var u=this._getShortestRoute(this._currentBranch,this._newBranch);var l=this.getCurrentState().name;var s=o.state.name;var r;if(arguments.length>1){r=Array.prototype.slice.call(arguments);r.shift()}else{r=[]}this._internalState="guarding";var q=c(r,new f.StateEvent(f.Action.EXIT,l,s));var p=this._executeGuards(u.up,q);if(!p){q=c(r,new f.StateEvent(f.StateEvent.EXIT_DENIED,l,s));this.dispatch.apply(this,q)}else{q=c(r,new f.StateEvent(f.Action.ENTRY,l,s));p=this._executeGuards(u.down,q)}if(!p){q=c(r,new f.StateEvent(f.StateEvent.ENTRY_DENIED,l,s));this.dispatch.apply(this,q);this._internalState="ready"}else{this._internalState="transitioning";var k=[{state:this}];q=c(r,new f.StateEvent(f.StateEvent.EXITED,l,s));this._addToQueue(u.up,q);this._addToQueue(k,q);q=c(r,new f.StateEvent(f.StateEvent.ENTERED,l,s));this._addToQueue(u.down,q);this._addToQueue(k,q);this.proceed()}}}};f.Automaton.prototype.parse=function(h){for(var g in h){if(h.hasOwnProperty(g)){this.createState(g,h[g])}}};f.Automaton.prototype.proceed=function(){if(this._internalState!=="ready"&&this._internalState!=="guarding"){if(this._queue.length>0){this._internalState="transitioning";var h=this._queue.shift();var g=h.obj.state;g._executeAction(h.args);if(this._internalState!=="paused"){this.proceed()}}else{this._finishTransition()}}};f.Automaton.prototype.pause=function(){if(this._internalState==="transitioning"){this._internalState="paused"}};f.Automaton.prototype.destroy=function(){this._rootNode.destroy();this._rootNode=undefined;this._nodes=undefined;this._currentStateBranch=undefined};f.Automaton.prototype._getBranchFromRoot=function(h){var g=[];while(h){g.unshift(h);h=h.parent}return g};f.Automaton.prototype._getShortestRoute=function(k,j){var h,m=Math.min(k.length,j.length);for(h=0;h<m;h++){if(k[h]!==j[h]){break}}var g=k.slice(h).reverse();var l=j.slice(h);return{up:g,down:l}};f.Automaton.prototype._executeGuards=function(h,j){var g=true;for(var k=0,m=h.length;k<m;k++){var l=h[k].state;g=l._executeGuards(j)&&g}return g};f.Automaton.prototype._addToQueue=function(j,g){for(var h=0,k=j.length;h<k;h++){this._queue.push({obj:j[h],args:g})}};f.Automaton.prototype._finishTransition=function(){this._internalState="ready";this._currentBranch=this._newBranch;this._newBranch=undefined};f.Automaton.prototype._executeAction=f.State.prototype._executeAction;e.fsa=f}(this));