/*! jsfsa - v0.2.5 - 2013-04-25 Copyright (c) 2013 Camille Reynders (http://www.creynders.be/); Licensed MIT */var jsfsa;(function(t){"use strict";var i=function(){this._listeners={}};i.prototype.addListener=function(t,i){return this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]),this._listeners[t].push(i),this},i.prototype.addListeners=function(t,i){if("function"==typeof i)return this.addListener(t,i);var r;return r=this._listeners.hasOwnProperty(t)?this._listeners[t]:[],this._listeners[t]=r.concat(i),this},i.prototype.hasListener=function(t,i){if(this._listeners.hasOwnProperty(t)){var r=this._listeners[t].indexOf(i);return r>=0}return!1},i.prototype.removeListener=function(t,i){if(this._listeners.hasOwnProperty(t)){var r=this._listeners[t].indexOf(i);r>=0&&this._listeners[t].splice(r,1)}return this},i.prototype.dispatch=function(t){var i=t.type,r=!0;if(this._listeners.hasOwnProperty(i))for(var n=Array.prototype.slice.call(arguments),e=0,s=this._listeners[i].length;s>e;e++){var a=this._listeners[i][e];r=a.apply(this,n)&&r}return r};var r=function(){};r.prototype=i.prototype;var n=function(t,i,r,n){this.fqn="jsfsa.StateEvent",this.type=t,this.from=i,this.to=r,this.transition=n};n.ENTERED="entered",n.EXITED="exited",n.ENTRY_DENIED="entryDenied",n.EXIT_DENIED="exitDenied",n.TRANSITION_DENIED="transitionDenied",n.CHANGED="changed",n.prototype.clone=function(){var t=new n(this.type,this.from,this.to,this.transition);return t},n.prototype._setType=function(t){return this.type=t,this};var e=function(){};e.ENTRY="entry",e.EXIT="exit";var s=function(t,r){i.call(this),this.fqn="jsfsa.State",this.name="",this.parent=void 0,this.isInitial=!1,this._guardian=void 0,this._transitions={},this._parseName(t),this.parseData(r)};s.prototype=new r,s.prototype.constructor=s,s._configMembers=["isInitial","guards","listeners","parent","transitions"],s.prototype.addTransition=function(t,i){return this._transitions[t]=i,this},s.prototype.removeTransition=function(t){return delete this._transitions[t],this},s.prototype.getTransition=function(t){return this._transitions[t]},s.prototype.hasTransition=function(t){return this._transitions.hasOwnProperty(t)},s.prototype.addGuard=function(t,i){return this._getGuardian().addListener(t,i),this},s.prototype.addGuards=function(t,i){return this._getGuardian().addListeners(t,i),this},s.prototype.hasGuard=function(t,i){return this._guardian&&this._guardian.hasListener(t,i)},s.prototype.removeGuard=function(t,i){return this._guardian&&this._guardian.removeListener(t,i),this},s.prototype.parseData=function(t){if(t){t.isInitial&&(this.isInitial=!0),t.guards&&(t.guards[e.ENTRY]&&this.addGuards(e.ENTRY,t.guards[e.ENTRY]),t.guards[e.EXIT]&&this.addGuards(e.EXIT,t.guards[e.EXIT]));for(var i in t.listeners)t.listeners.hasOwnProperty(i)&&this.addListeners(i,t.listeners[i]);t.parent&&(this.parent=t.parent),t.transitions&&this._addTransitions(t.transitions),this._addTransitions(t,s._configMembers)}},s.prototype.destroy=function(){this._guardian=void 0,this._transitions=void 0,this._listeners=void 0,this.name=void 0},s.prototype._getGuardian=function(){return void 0===this._guardian&&(this._guardian=new i),this._guardian},s.prototype._parseName=function(t){var i=t.lastIndexOf("/");i>=0&&(this.parent=t.substring(0,i)),this.name=t},s.prototype._executeGuards=function(t){var i=!0;if(this._guardian&&(i=this._guardian.dispatch.apply(this._guardian,t),!i)){t=t.slice(0);var r=t[0].clone();r.type+="Denied",t[0]=r,this.dispatch.apply(this,t)}return i},s.prototype._addTransitions=function(t,i){for(var r in t)if(t.hasOwnProperty(r)){if(i&&i.indexOf(r)>=0)continue;this.addTransition(r,t[r])}},s.prototype._dispatchArgs=function(t){this.dispatch.apply(this,t)};var a=function(t){this.state=t,this.parent=void 0,this.children=void 0,this.initialChild=void 0};a.prototype={addChild:function(t){this.children||(this.children={}),t.parent=this,t.state.isInitial&&(this.initialChild=t),this.children[t.state.name]=t},removeChild:function(t){this.initialChild===t&&(this.initialChild=void 0),delete this.children[t.state.name]},destroy:function(){for(var t in this.children)this.children.hasOwnProperty(t)&&this.children[t].destroy();this.state=void 0,this.parent=void 0,this.children=void 0},getInitialBranch:function(){for(var t=[],i=this.initialChild;i;)t.push(i),i=i.initialChild;return t}};var o=function(t,i,r,n){this.payload=t,this.from=r,this.to=n,this.transition=i};o.prototype={createEvent:function(t){return new n(t,this.from,this.to,this.transition)},createArgsArray:function(t){var i=this.payload.slice(0);return i.unshift(this.createEvent(t)),i}};var h=function(t,r){i.call(this),this.fqn="jsfsa.Automaton",this.name=r||"",this._nodes={},this._rootNode=new a(new s("root")),this._currentBranch=[this._rootNode],this._internalState="ready",this._queue=[],this._newBranch=void 0,t&&this.parse(t)};h.prototype=new r,h.prototype.constructor=h,h.prototype.isTransitioning=function(){return"ready"!==this._internalState},h.prototype.getRootState=function(){return this._rootNode.state},h.prototype.getCurrentState=function(){return this._currentBranch[this._currentBranch.length-1].state},h.prototype.getCurrentBranch=function(){for(var t=this._currentBranch,i=[],r=1;t.length>r;r++){var n=t[r];i.push(n.state)}return i},h.prototype.isInCurrentBranch=function(t){var i=this._nodes[t];return i?this._currentBranch.indexOf(i)>-1:!1},h.prototype.createState=function(t,i){var r=new s(t,i);return this.addState(r),this},h.prototype.addState=function(t){if(!this.hasState(t.name)){var i=new a(t),r=t.parent?this._nodes[t.parent]:this._rootNode;r.addChild(i),t.isInitial&&r.state===this.getCurrentState()&&this._currentBranch.push(i),this._nodes[t.name]=i}return this},h.prototype.hasState=function(t){return this._nodes.hasOwnProperty(t)},h.prototype.getState=function(t){return this.hasState(t)?this._nodes[t].state:void 0},h.prototype.removeState=function(t){if(this.hasState(t)){var i=this._nodes[t],r=i.parent;r.removeChild(i);var n=this._currentBranch.indexOf(i);n>=0&&this._currentBranch.splice(n,this._currentBranch.length-n),i.destroy(),delete this._nodes[t]}return this},h.prototype.doTransition=function(t){if("ready"===this._internalState){var i;arguments.length>1?(i=Array.prototype.slice.call(arguments),i.shift()):i=[],this._newBranch=this._currentBranch;var r=new o(i,t,this.getCurrentState().name),e=this._hasTransitionInCurrentBranch(t);void 0===e?this._finishTransition(r.createArgsArray(n.TRANSITION_DENIED)):this._attemptTransition(e,r)}return this},h.prototype.parse=function(t){for(var i in t)t.hasOwnProperty(i)&&this.createState(i,t[i]);return this},h.prototype.proceed=function(){if(("transitioning"===this._internalState||"paused"===this._internalState)&&this._queue.length>0){this._internalState="transitioning";var t=this._queue.shift(),i=t.obj.state;i[t.method].call(i,t.args),"paused"!==this._internalState&&this.proceed()}return this},h.prototype.pause=function(){return"transitioning"===this._internalState&&(this._internalState="paused"),this},h.prototype.destroy=function(){this._rootNode.destroy(),this._rootNode=void 0,this._nodes=void 0,this._currentBranch=void 0},h.prototype._hasTransitionInCurrentBranch=function(t){for(var i,r=!1,n=this._currentBranch.length-1,e=0;n>=e;n--)if(i=this._currentBranch[n].state,i.hasTransition(t)){r=!0;break}return r?i:void 0},h.prototype._attemptTransition=function(t,i){var r=this._nodes[t.getTransition(i.transition)];if(r){i.to=r.state.name;var e=r.getInitialBranch();this._newBranch=this._getBranchFromRoot(r).concat(e);var s=this._getShortestRoute(this._currentBranch,this._newBranch);this._doExitGuardPhase(s,i)}else this._finishTransition(i.createArgsArray(n.TRANSITION_DENIED))},h.prototype._getBranchFromRoot=function(t){for(var i=[];t;)i.unshift(t),t=t.parent;return i},h.prototype._getShortestRoute=function(t,i){var r,n=Math.min(t.length,i.length);for(r=0;n>r&&t[r]===i[r];r++);var e=t.slice(r).reverse(),s=i.slice(r);return{up:e,down:s}},h.prototype._doExitGuardPhase=function(t,i){this._internalState="guarding";var r=this._executeGuards(t.up,i.createArgsArray(e.EXIT));return r?r=this._doEntryGuardPhase(t,i):(this._newBranch=void 0,this._finishTransition(i.createArgsArray(n.EXIT_DENIED))),r},h.prototype._doEntryGuardPhase=function(t,i){var r=this._executeGuards(t.down,i.createArgsArray(e.ENTRY));return r?this._startTransition(t,i):(this._newBranch=void 0,this._finishTransition(i.createArgsArray(n.ENTRY_DENIED))),r},h.prototype._executeGuards=function(t,i){for(var r=!0,n=0,e=t.length;e>n;n++){var s=t[n].state;r=s._executeGuards(i)&&r}return r},h.prototype._startTransition=function(t,i){this._internalState="transitioning",this._currentBranch=void 0;var r=[{state:this}],e=i.createArgsArray(n.EXITED);this._queue=[],this._addToQueue(t.up,"_dispatchArgs",e),this._addToQueue(r,"_dispatchArgs",e),e=i.createArgsArray(n.ENTERED),this._addToQueue(t.down,"_dispatchArgs",e),this._addToQueue(r,"_dispatchArgs",e),this._addToQueue(r,"_finishTransition",i.createArgsArray(n.CHANGED)),this.proceed()},h.prototype._addToQueue=function(t,i,r){for(var n=0,e=t.length;e>n;n++)this._queue.push({obj:t[n],args:r,method:i})},h.prototype._finishTransition=function(t){this._newBranch?this._currentBranch=this._newBranch:this._newBranch=void 0,this._internalState="ready",this._dispatchArgs(t)},h.prototype._dispatchArgs=s.prototype._dispatchArgs,t.VERSION="0.2.5",t.Action=e,t.StateEvent=n,t.State=s,t.Automaton=h})(jsfsa||(jsfsa={}));