(function(f){if(f.hasOwnProperty("jsfsa")){return}var d=function(h,i){var g=h.slice(0);g.unshift(i);return g};var c={};c.VERSION="0.2.2";var a=function(){this._listeners={}};a.prototype.addListener=function(g,h){if(!this._listeners.hasOwnProperty(g)){this._listeners[g]=[]}this._listeners[g].push(h);return this};a.prototype.addListeners=function(i,h){if(typeof h==="function"){return this.addListener(i,h)}var g;if(!this._listeners.hasOwnProperty(i)){g=[]}else{g=this._listeners[i]}this._listeners[i]=g.concat(h);return this};a.prototype.hasListener=function(g,i){if(this._listeners.hasOwnProperty(g)){var h=this._listeners[g].indexOf(i);return h>=0}return false};a.prototype.removeListener=function(g,i){if(this._listeners.hasOwnProperty(g)){var h=this._listeners[g].indexOf(i);if(h>=0){this._listeners[g].splice(h,1)}}return this};a.prototype.dispatch=function(m){var h=m.type;var g=true;if(this._listeners.hasOwnProperty(h)){var j=Array.prototype.slice.call(arguments);for(var k=0,o=this._listeners[h].length;k<o;k++){var l=this._listeners[h][k];g=l.apply(this,j)&&g}}return g};var e=function(){};e.prototype=a.prototype;c.StateEvent=function(g,j,i,h){this.fqn="jsfsa.StateEvent";this.type=g;this.from=j;this.to=i;this.transition=h};c.StateEvent.ENTERED="entered";c.StateEvent.EXITED="exited";c.StateEvent.ENTRY_DENIED="entryDenied";c.StateEvent.EXIT_DENIED="exitDenied";c.StateEvent.TRANSITION_DENIED="transitionDenied";c.StateEvent.CHANGED="changed";c.StateEvent.prototype={clone:function(){var g=new c.StateEvent(this.type,this.from,this.to,this.transition);return g},_setType:function(g){this.type=g;return this}};c.Action=function(){};c.Action.ENTRY="entry";c.Action.EXIT="exit";c.State=function(g,h){a.call(this);this.fqn="jsfsa.State";this.name="";this.parent=undefined;this.isInitial=false;this._guardian=undefined;this._transitions={};this._parseName(g);this.parseData(h)};c.State.prototype=new e();c.State.prototype.constructor=c.State;c.State._configMembers=["isInitial","guards","listeners","parent","transitions"];c.State.prototype.addTransition=function(g,h){this._transitions[g]=h;return this};c.State.prototype.removeTransition=function(g){delete this._transitions[g];return this};c.State.prototype.getTransition=function(g){return this._transitions[g]};c.State.prototype.hasTransition=function(g){return this._transitions.hasOwnProperty(g)};c.State.prototype.addGuard=function(h,g){this._getGuardian().addListener(h,g);return this};c.State.prototype.addGuards=function(h,g){this._getGuardian().addListeners(h,g);return this};c.State.prototype.hasGuard=function(h,g){return this._guardian&&this._guardian.hasListener(h,g)};c.State.prototype.removeGuard=function(h,g){if(this._guardian){this._guardian.removeListener(h,g)}return this};c.State.prototype.parseData=function(h){if(h){if(h.isInitial){this.isInitial=true}if(h.guards){if(h.guards[c.Action.ENTRY]){this.addGuards(c.Action.ENTRY,h.guards[c.Action.ENTRY])}if(h.guards[c.Action.EXIT]){this.addGuards(c.Action.EXIT,h.guards[c.Action.EXIT])}}for(var g in h.listeners){if(h.listeners.hasOwnProperty(g)){this.addListeners(g,h.listeners[g])}}if(h.parent){this.parent=h.parent}if(h.transitions){this._addTransitions(h.transitions)}this._addTransitions(h,c.State._configMembers)}};c.State.prototype.destroy=function(){this._guardian=undefined;this._transitions=undefined;this._listeners=undefined;this.name=undefined};c.State.prototype._getGuardian=function(){if(this._guardian===undefined){this._guardian=new a()}return this._guardian};c.State.prototype._parseName=function(h){var g=h.lastIndexOf("/");if(g>=0){this.parent=h.substring(0,g)}this.name=h};c.State.prototype._executeGuards=function(h){var g=true;if(this._guardian){g=this._guardian.dispatch.apply(this._guardian,h);if(!g){h=h.slice(0);var i=h[0].clone();i.type+="Denied";h[0]=i;this.dispatch.apply(this,h)}}return g};c.State.prototype._addTransitions=function(i,h){for(var g in i){if(i.hasOwnProperty(g)){if(h&&h.indexOf(g)>=0){continue}this.addTransition(g,i[g])}}};c.State.prototype._executeAction=function(g){this.dispatch.apply(this,g)};var b=function(g){this.state=g;this.parent=undefined;this.children=undefined;this.initialChild=undefined};b.prototype={addChild:function(g){if(!this.children){this.children={}}g.parent=this;if(g.state.isInitial){this.initialChild=g}this.children[g.state.name]=g},removeChild:function(g){if(this.initialChild===g){this.initialChild=undefined}delete this.children[g.state.name]},destroy:function(){for(var g in this.children){if(this.children.hasOwnProperty(g)){this.children[g].destroy()}}this.state=undefined;this.parent=undefined;this.children=undefined},getInitialBranch:function(){var g=[];var h=this.initialChild;while(h){g.push(h);h=h.initialChild}return g}};c.Automaton=function(g){a.call(this);this.fqn="jsfsa.Automaton";this._nodes={};this._rootNode=new b(new c.State("root"));this._currentBranch=[this._rootNode];this._internalState="ready";this._queue=[];this._newBranch=undefined;if(g){this.parse(g)}};c.Automaton.prototype=new e();c.Automaton.prototype.constructor=c.Automaton;c.Automaton.prototype.isTransitioning=function(){return this._internalState==="transitioning"||this._internalState==="paused"};c.Automaton.prototype.getRootState=function(){return this._rootNode.state};c.Automaton.prototype.getCurrentState=function(){return this._currentBranch[this._currentBranch.length-1].state};c.Automaton.prototype.createState=function(i,g){var h=new c.State(i,g);this.addState(h);return this};c.Automaton.prototype.addState=function(i){if(!this.hasState(i.name)){var h=new b(i);var g=(i.parent)?this._nodes[i.parent]:this._rootNode;g.addChild(h);if(i.isInitial&&g.state===this.getCurrentState()){this._currentBranch.push(h)}this._nodes[i.name]=h}return this};c.Automaton.prototype.hasState=function(g){return this._nodes.hasOwnProperty(g)};c.Automaton.prototype.getState=function(g){if(this.hasState(g)){return this._nodes[g].state}return undefined};c.Automaton.prototype.removeState=function(j){if(this.hasState(j)){var i=this._nodes[j];var g=i.parent;g.removeChild(i);var h=this._currentBranch.indexOf(i);if(h>=0){this._currentBranch.splice(h,this._currentBranch.length-h)}i.destroy();delete this._nodes[j]}return this};c.Automaton.prototype.doTransition=function(g){if(this._internalState==="ready"){var s;var u=false;for(var m=this._currentBranch.length-1,k=0;m>=k;m--){s=this._currentBranch[m].state;if(s.hasTransition(g)){u=true;break}}var r;if(arguments.length>1){r=Array.prototype.slice.call(arguments);r.shift()}else{r=[]}var h=new c.StateEvent("",this.getCurrentState().name,undefined,g);var q=d(r,h.clone()._setType(c.StateEvent.TRANSITION_DENIED));if(!u){this.dispatch.apply(this,q)}else{var o=this._nodes[s.getTransition(g)];if(!o){this.dispatch.apply(this,q)}else{h.to=o.state.name;var j=o.getInitialBranch();this._newBranch=this._getBranchFromRoot(o).concat(j);var t=this._getShortestRoute(this._currentBranch,this._newBranch);this._internalState="guarding";q=d(r,h.clone()._setType(c.Action.EXIT));var p=this._executeGuards(t.up,q);if(!p){q=d(r,h.clone()._setType(c.StateEvent.EXIT_DENIED));this.dispatch.apply(this,q)}else{q=d(r,h.clone()._setType(c.Action.ENTRY));p=this._executeGuards(t.down,q)}if(!p){q=d(r,h.clone()._setType(c.StateEvent.ENTRY_DENIED));this.dispatch.apply(this,q);this._internalState="ready"}else{this._internalState="transitioning";var l=[{state:this}];q=d(r,h.clone()._setType(c.StateEvent.EXITED));this._addToQueue(t.up,"_executeAction",q);this._addToQueue(l,"_executeAction",q);q=d(r,h.clone()._setType(c.StateEvent.ENTERED));this._addToQueue(t.down,"_executeAction",q);this._addToQueue(l,"_executeAction",q);q=d(r,h.clone()._setType(c.StateEvent.CHANGED));this._addToQueue(l,"_finishTransition",q);this.proceed()}}}}return this};c.Automaton.prototype.parse=function(h){for(var g in h){if(h.hasOwnProperty(g)){this.createState(g,h[g])}}return this};c.Automaton.prototype.proceed=function(){if(this._internalState!=="ready"&&this._internalState!=="guarding"){if(this._queue.length>0){this._internalState="transitioning";var h=this._queue.shift();var g=h.obj.state;g[h.method].call(g,h.args);if(this._internalState!=="paused"){this.proceed()}}}return this};c.Automaton.prototype.pause=function(){if(this._internalState==="transitioning"){this._internalState="paused"}return this};c.Automaton.prototype.destroy=function(){this._rootNode.destroy();this._rootNode=undefined;this._nodes=undefined;this._currentBranch=undefined};c.Automaton.prototype._getBranchFromRoot=function(h){var g=[];while(h){g.unshift(h);h=h.parent}return g};c.Automaton.prototype._getShortestRoute=function(k,j){var h,m=Math.min(k.length,j.length);for(h=0;h<m;h++){if(k[h]!==j[h]){break}}var g=k.slice(h).reverse();var l=j.slice(h);return{up:g,down:l}};c.Automaton.prototype._executeGuards=function(h,j){var g=true;for(var k=0,m=h.length;k<m;k++){var l=h[k].state;g=l._executeGuards(j)&&g}return g};c.Automaton.prototype._addToQueue=function(j,l,g){for(var h=0,k=j.length;h<k;h++){this._queue.push({obj:j[h],args:g,method:l})}};c.Automaton.prototype._finishTransition=function(g){this._internalState="ready";this._currentBranch=this._newBranch;this._newBranch=undefined;this._executeAction(g)};c.Automaton.prototype._executeAction=c.State.prototype._executeAction;f.jsfsa=c}(this));