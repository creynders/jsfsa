/*! jsfsa - v0.3.1 - 2013-05-29 Copyright (c) 2013 Camille Reynders (http://www.creynders.be/); Licensed MIT */(function(t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(t):jsfsa=t()})(function(){"use strict";var t=function(){this._listeners={}};t.prototype.addListener=function(t,i){return this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]),this._listeners[t].push(i),this},t.prototype.addListeners=function(t,i){if("function"==typeof i)return this.addListener(t,i);var r;return r=this._listeners.hasOwnProperty(t)?this._listeners[t]:[],this._listeners[t]=r.concat(i),this},t.prototype.hasListener=function(t,i){if(this._listeners.hasOwnProperty(t)){var r=this._listeners[t].indexOf(i);return r>=0}return!1},t.prototype.removeListener=function(t,i){if(this._listeners.hasOwnProperty(t)){var r=this._listeners[t].indexOf(i);r>=0&&this._listeners[t].splice(r,1)}return this},t.prototype.dispatch=function(t){var i=t.type,r=!0;if(this._listeners.hasOwnProperty(i))for(var e=Array.prototype.slice.call(arguments),n=0,s=this._listeners[i].length;s>n;n++){var a=this._listeners[i][n];r=a.apply(this,e)&&r}return r};var i=function(){};i.prototype=t.prototype;var r=function(t,i,r,e){this.fqn="jsfsa.StateEvent",this.type=t,this.from=i,this.to=r,this.transition=e};r.ENTERED="entered",r.EXITED="exited",r.ENTRY_DENIED="entryDenied",r.EXIT_DENIED="exitDenied",r.TRANSITION_DENIED="transitionDenied",r.CHANGED="changed",r.prototype.clone=function(){var t=new r(this.type,this.from,this.to,this.transition);return t},r.prototype._setType=function(t){return this.type=t,this};var e=function(){};e.ENTRY="entry",e.EXIT="exit";var n=function(i,r){t.call(this),this.fqn="jsfsa.State",this.name="",this.parent=void 0,this.isInitial=!1,this._guardian=void 0,this._transitions={},this._parseName(i),this.parseData(r)};n.prototype=new i,n.prototype.constructor=n,n._configMembers=["isInitial","guards","listeners","parent","transitions"],n.prototype.addTransition=function(t,i){return this._transitions[t]=i,this},n.prototype.removeTransition=function(t){return delete this._transitions[t],this},n.prototype.getTransition=function(t){return this._transitions[t]},n.prototype.hasTransition=function(t){return this._transitions.hasOwnProperty(t)},n.prototype.addGuard=function(t,i){return this._getGuardian().addListener(t,i),this},n.prototype.addGuards=function(t,i){return this._getGuardian().addListeners(t,i),this},n.prototype.hasGuard=function(t,i){return this._guardian&&this._guardian.hasListener(t,i)},n.prototype.removeGuard=function(t,i){return this._guardian&&this._guardian.removeListener(t,i),this},n.prototype.parseData=function(t){if(t){t.isInitial&&(this.isInitial=!0),t.guards&&(t.guards[e.ENTRY]&&this.addGuards(e.ENTRY,t.guards[e.ENTRY]),t.guards[e.EXIT]&&this.addGuards(e.EXIT,t.guards[e.EXIT]));for(var i in t.listeners)t.listeners.hasOwnProperty(i)&&this.addListeners(i,t.listeners[i]);t.parent&&(this.parent=t.parent),t.transitions&&this._addTransitions(t.transitions),this._addTransitions(t,n._configMembers)}},n.prototype.destroy=function(){this._guardian=void 0,this._transitions=void 0,this._listeners=void 0,this.name=void 0},n.prototype._getGuardian=function(){return void 0===this._guardian&&(this._guardian=new t),this._guardian},n.prototype._parseName=function(t){var i=t.lastIndexOf("/");i>=0&&(this.parent=t.substring(0,i)),this.name=t},n.prototype._executeGuards=function(t){var i=!0;if(this._guardian&&(i=this._guardian.dispatch.apply(this._guardian,t),!i)){t=t.slice(0);var r=t[0].clone();r.type+="Denied",t[0]=r,this.dispatch.apply(this,t)}return i},n.prototype._addTransitions=function(t,i){for(var r in t)if(t.hasOwnProperty(r)){if(i&&i.indexOf(r)>=0)continue;this.addTransition(r,t[r])}},n.prototype._dispatchArgs=function(t){this.dispatch.apply(this,t)};var s=function(t){this.state=t,this.parent=void 0,this.children=void 0,this.initialChild=void 0};s.prototype={addChild:function(t){this.children||(this.children={}),t.parent=this,t.state.isInitial&&(this.initialChild=t),this.children[t.state.name]=t},removeChild:function(t){this.initialChild===t&&(this.initialChild=void 0),delete this.children[t.state.name]},destroy:function(){for(var t in this.children)this.children.hasOwnProperty(t)&&this.children[t].destroy();this.state=void 0,this.parent=void 0,this.children=void 0},getInitialBranch:function(){for(var t=[],i=this.initialChild;i;)t.push(i),i=i.initialChild;return t}};var a=function(t,i,r,e){this.payload=t,this.from=r,this.to=e,this.transition=i};a.prototype={createEvent:function(t){return new r(t,this.from,this.to,this.transition)},createArgsArray:function(t){var i=this.payload.slice(0);return i.unshift(this.createEvent(t)),i}};var o=function(i,r){t.call(this),this.fqn="jsfsa.Automaton",this.name=r||"",this._nodes={},this._rootNode=new s(new n("root")),this._currentBranch=[this._rootNode],this._internalState="ready",this._queue=[],this._newBranch=void 0,i&&this.parse(i)};return o.prototype=new i,o.prototype.constructor=o,o.prototype.isTransitioning=function(){return"ready"!==this._internalState},o.prototype.getRootState=function(){return this._rootNode.state},o.prototype.getCurrentState=function(){return this._currentBranch[this._currentBranch.length-1].state},o.prototype.getCurrentBranch=function(){for(var t=this._currentBranch,i=[],r=1;t.length>r;r++){var e=t[r];i.push(e.state)}return i},o.prototype.isInCurrentBranch=function(t){var i=this._nodes[t];return i?this._currentBranch.indexOf(i)>-1:!1},o.prototype.createState=function(t,i){var r=new n(t,i);return this.addState(r),this},o.prototype.addState=function(t){if(!this.hasState(t.name)){var i=new s(t),r=t.parent?this._nodes[t.parent]:this._rootNode;r.addChild(i),t.isInitial&&r.state===this.getCurrentState()&&this._currentBranch.push(i),this._nodes[t.name]=i}return this},o.prototype.hasState=function(t){return this._nodes.hasOwnProperty(t)},o.prototype.getState=function(t){return this.hasState(t)?this._nodes[t].state:void 0},o.prototype.removeState=function(t){if(this.hasState(t)){var i=this._nodes[t],r=i.parent;r.removeChild(i);var e=this._currentBranch.indexOf(i);e>=0&&this._currentBranch.splice(e,this._currentBranch.length-e),i.destroy(),delete this._nodes[t]}return this},o.prototype.doTransition=function(t){if("ready"===this._internalState){var i;arguments.length>1?(i=Array.prototype.slice.call(arguments),i.shift()):i=[],this._newBranch=this._currentBranch;var e=new a(i,t,this.getCurrentState().name),n=this._hasTransitionInCurrentBranch(t);void 0===n?this._finishTransition(e.createArgsArray(r.TRANSITION_DENIED)):this._attemptTransition(n,e)}return this},o.prototype.parse=function(t){for(var i in t)t.hasOwnProperty(i)&&this.createState(i,t[i]);return this},o.prototype.proceed=function(){if(("transitioning"===this._internalState||"paused"===this._internalState)&&this._queue.length>0){this._internalState="transitioning";var t=this._queue.shift(),i=t.obj.state;i[t.method].call(i,t.args),"paused"!==this._internalState&&this.proceed()}return this},o.prototype.pause=function(){return"transitioning"===this._internalState&&(this._internalState="paused"),this},o.prototype.destroy=function(){this._rootNode.destroy(),this._rootNode=void 0,this._nodes=void 0,this._currentBranch=void 0},o.prototype._hasTransitionInCurrentBranch=function(t){for(var i,r=!1,e=this._currentBranch.length-1,n=0;e>=n;e--)if(i=this._currentBranch[e].state,i.hasTransition(t)){r=!0;break}return r?i:void 0},o.prototype._attemptTransition=function(t,i){var e,n=t.getTransition(i.transition);if("function"==typeof n){var s=i.createArgsArray();e=n.apply(this,s)}else e=n;var a=null;if(e&&(a=this._nodes[e]),a){i.to=a.state.name;var o=a.getInitialBranch();this._newBranch=this._getBranchFromRoot(a).concat(o);var h=this._getShortestRoute(this._currentBranch,this._newBranch);this._doExitGuardPhase(h,i)}else this._finishTransition(i.createArgsArray(r.TRANSITION_DENIED))},o.prototype._getBranchFromRoot=function(t){for(var i=[];t;)i.unshift(t),t=t.parent;return i},o.prototype._getShortestRoute=function(t,i){var r,e=Math.min(t.length,i.length);for(r=0;e>r&&t[r]===i[r];r++);var n=t.slice(r).reverse(),s=i.slice(r);return{up:n,down:s}},o.prototype._doExitGuardPhase=function(t,i){this._internalState="guarding";var n=this._executeGuards(t.up,i.createArgsArray(e.EXIT));return n?n=this._doEntryGuardPhase(t,i):(this._newBranch=void 0,this._finishTransition(i.createArgsArray(r.EXIT_DENIED))),n},o.prototype._doEntryGuardPhase=function(t,i){var n=this._executeGuards(t.down,i.createArgsArray(e.ENTRY));return n?this._startTransition(t,i):(this._newBranch=void 0,this._finishTransition(i.createArgsArray(r.ENTRY_DENIED))),n},o.prototype._executeGuards=function(t,i){for(var r=!0,e=0,n=t.length;n>e;e++){var s=t[e].state;r=s._executeGuards(i)&&r}return r},o.prototype._startTransition=function(t,i){this._internalState="transitioning",this._currentBranch=void 0;var e=[{state:this}],n=i.createArgsArray(r.EXITED);this._queue=[],this._addToQueue(t.up,"_dispatchArgs",n),this._addToQueue(e,"_dispatchArgs",n),n=i.createArgsArray(r.ENTERED),this._addToQueue(t.down,"_dispatchArgs",n),this._addToQueue(e,"_dispatchArgs",n),this._addToQueue(e,"_finishTransition",i.createArgsArray(r.CHANGED)),this.proceed()},o.prototype._addToQueue=function(t,i,r){for(var e=0,n=t.length;n>e;e++)this._queue.push({obj:t[e],args:r,method:i})},o.prototype._finishTransition=function(t){this._newBranch?this._currentBranch=this._newBranch:this._newBranch=void 0,this._internalState="ready",this._dispatchArgs(t)},o.prototype._dispatchArgs=n.prototype._dispatchArgs,{VERSION:"0.3.1",Action:e,StateEvent:r,State:n,Automaton:o}});